{% extends "base.html" %} {% block title %}Bookmarked News - UPSC Aspirant{%
endblock %} {% block content %}
<div class="bg-gray-100 min-h-screen">
  <main class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-gray-800">Bookmarked News</h1>
      <a
        href="{{ url_for('current_affairs') }}"
        class="text-blue-600 hover:text-blue-800 flex items-center gap-2"
      >
        <i class="fas fa-arrow-left"></i>
        <span>Back to Current Affairs</span>
      </a>
    </div>

    <!-- Filter and Search -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-grow">
          <input
            type="text"
            id="searchBookmarks"
            placeholder="Search your bookmarks..."
            class="border rounded-md px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div class="flex gap-2">
          <select
            id="sortBookmarks"
            class="border rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <option value="date-desc">Newest First</option>
            <option value="date-asc">Oldest First</option>
            <option value="title-asc">Title A-Z</option>
            <option value="title-desc">Title Z-A</option>
          </select>
          <button
            id="clearAllBookmarks"
            class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors"
          >
            Clear All
          </button>
        </div>
      </div>
    </div>

    <!-- No Bookmarks Message -->
    {% if not bookmarks %}
    <div class="bg-white rounded-lg shadow-md p-8 text-center">
      <div
        class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"
      >
        <i class="fas fa-bookmark text-gray-400 text-2xl"></i>
      </div>
      <h2 class="text-xl font-semibold mb-2">No Bookmarks Yet</h2>
      <p class="text-gray-600 mb-6">
        You haven't saved any articles yet. Start exploring news and bookmark
        articles you find interesting.
      </p>
      <a
        href="{{ url_for('current_affairs') }}"
        class="inline-block bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition-colors"
      >
        Explore News
      </a>
    </div>
    {% else %}

    <!-- Bookmarks Grid -->
    <div
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
      id="bookmarksContainer"
    >
      {% for article in bookmarks %}
      <div
        class="bookmark-item bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow h-full flex flex-col"
        data-title="{{ article.title|lower }}"
        data-date="{{ article.bookmarked_at }}"
      >
        <div class="relative h-48 overflow-hidden">
        
          <div class="absolute top-0 right-0 m-2">
            <button
              onclick="removeBookmark(this, '{{ article.url }}')"
              data-article="{{ article|tojson|safe }}"
              class="bg-white/80 hover:bg-white p-2 rounded-full transition-colors"
              aria-label="Remove bookmark"
            >
              <i class="fas fa-times text-red-600"></i>
            </button>
          </div>
          <div class="absolute bottom-0 left-0 m-2">
            <span
              class="bg-blue-600 text-white text-xs font-medium px-2.5 py-0.5 rounded"
            >
              {{ article.source.name if article.source and article.source.name
              else 'News' }}
            </span>
          </div>
        </div>
        <div class="p-4 flex flex-col flex-grow">
          <h3 class="text-lg font-semibold mb-2 line-clamp-2">
            {{ article.title }}
          </h3>
          <p class="text-sm text-gray-600 mb-4 flex-grow line-clamp-3">
            {{ article.description }}
          </p>
          <div
            class="flex justify-between items-center mt-auto pt-2 border-t border-gray-100"
          >
            <a
              href="{{ article.url }}"
              target="_blank"
              class="text-sm bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors"
              >Read Article</a
            >
            <span class="text-xs text-gray-500">
              Saved on {{ article.bookmarked_at.split(' ')[0] if
              article.bookmarked_at else '' }}
            </span>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </main>
</div>

<script>
  const searchInput = document.getElementById("searchBookmarks");
  const sortSelect = document.getElementById("sortBookmarks");
  const clearAllBtn = document.getElementById("clearAllBookmarks");
  const bookmarksContainer = document.getElementById("bookmarksContainer");

  if (searchInput && sortSelect && clearAllBtn && bookmarksContainer) {
    // Search functionality
    searchInput.addEventListener("input", filterBookmarks);

    // Sort functionality
    sortSelect.addEventListener("change", sortBookmarks);

    // Clear all functionality
    clearAllBtn.addEventListener("click", confirmClearAll);

    // Initial sort
    sortBookmarks();
  }

  function filterBookmarks() {
    const searchTerm = searchInput.value.toLowerCase();
    const bookmarkItems = document.querySelectorAll(".bookmark-item");

    bookmarkItems.forEach((item) => {
      const title = item.getAttribute("data-title");
      if (title.includes(searchTerm)) {
        item.style.display = "flex";
      } else {
        item.style.display = "none";
      }
    });
  }

  function sortBookmarks() {
    const sortValue = sortSelect.value;
    const bookmarkItems = Array.from(
      document.querySelectorAll(".bookmark-item")
    );

    bookmarkItems.sort((a, b) => {
      if (sortValue === "date-desc") {
        return b
          .getAttribute("data-date")
          .localeCompare(a.getAttribute("data-date"));
      } else if (sortValue === "date-asc") {
        return a
          .getAttribute("data-date")
          .localeCompare(b.getAttribute("data-date"));
      } else if (sortValue === "title-asc") {
        return a
          .getAttribute("data-title")
          .localeCompare(b.getAttribute("data-title"));
      } else if (sortValue === "title-desc") {
        return b
          .getAttribute("data-title")
          .localeCompare(a.getAttribute("data-title"));
      }
    });

    // Reorder in DOM
    bookmarkItems.forEach((item) => {
      bookmarksContainer.appendChild(item);
    });
  }

  function confirmClearAll() {
    if (
      confirm(
        "Are you sure you want to remove all bookmarks? This action cannot be undone."
      )
    ) {
      clearAllBookmarks();
    }
  }

  function clearAllBookmarks() {
    fetch("/clear-bookmarks", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "success") {
          // Replace content with empty state
          const emptyState = `
            <div class="bg-white rounded-lg shadow-md p-8 text-center">
              <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-bookmark text-gray-400 text-2xl"></i>
              </div>
              <h2 class="text-xl font-semibold mb-2">No Bookmarks</h2>
              <p class="text-gray-600 mb-6">You've cleared all your bookmarks. Start exploring news and bookmark articles you find interesting.</p>
              <a
                href="{{ url_for('current_affairs') }}"
                class="inline-block bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition-colors"
              >
                Explore News
              </a>
            </div>
          `;
          document.querySelector("main.container").innerHTML = emptyState;
          showNotification("All bookmarks cleared successfully", "success");
        } else {
          showNotification("Failed to clear bookmarks", "error");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        showNotification("An error occurred", "error");
      });
  }

  function removeBookmark(button, url) {
    const article = JSON.parse(button.getAttribute("data-article"));
    const bookmarkItem = button.closest(".bookmark-item");

    // Add loading state
    button.disabled = true;
    button.querySelector("i").classList.add("fa-spin");

    fetch("/bookmark", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(article),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.action === "removed") {
          // Remove with animation
          bookmarkItem.style.opacity = "0";
          setTimeout(() => {
            bookmarkItem.remove();

            // Check if any bookmarks remain
            if (document.querySelectorAll(".bookmark-item").length === 0) {
              location.reload(); // Reload to show empty state
            }
          }, 300);

          showNotification("Article removed from bookmarks", "info");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        // Remove loading state
        button.disabled = false;
        button.querySelector("i").classList.remove("fa-spin");
        showNotification("Failed to remove bookmark", "error");
      });
  }

  // Notification function
  function showNotification(message, type = "info") {
    // Create notification element
    const notification = document.createElement("div");

    // Set classes based on type
    let bgColor = "bg-blue-500";
    let icon = "fa-info-circle";

    if (type === "success") {
      bgColor = "bg-green-500";
      icon = "fa-check-circle";
    } else if (type === "error") {
      bgColor = "bg-red-500";
      icon = "fa-exclamation-circle";
    }

    // Set notification content and styling
    notification.className = `fixed bottom-4 right-4 ${bgColor} text-white px-4 py-3 rounded-md shadow-lg flex items-center transition-opacity duration-300 z-50`;
    notification.innerHTML = `
      <i class="fas ${icon} mr-2"></i>
      <span>${message}</span>
    `;

    // Add to document
    document.body.appendChild(notification);

    // Remove after 3 seconds
    setTimeout(() => {
      notification.style.opacity = "0";
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 300);
    }, 3000);
  }
</script>
{% endblock %}
