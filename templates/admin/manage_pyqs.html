{% extends 'base.html' %} {% block content %}
<div class="max-w-full mx-auto px-4">
<div class="mb-4">
  <button
    onclick="window.history.back()"
    class="flex items-center text-blue-600 hover:text-blue-800 font-semibold"
  >
    <i class="fas fa-arrow-left mr-2"></i>
   
  </button>
</div>


  <h2 class="text-3xl font-bold mb-6 text-gray-800">Manage PYQs</h2>

  <div class="bg-white rounded-xl shadow p-4">
    <div class="flex justify-between items-center mb-4">
      <div>
        <input
          type="text"
          id="search-input"
          placeholder="Search PYQs..."
          class="border rounded px-3 py-1 w-64"
        />
      </div>
      <div>
        <button
          onclick="addNewRow()"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        >
          + Add New PYQ
        </button>
      </div>
    </div>

    <table class="min-w-full text-sm text-left">
      <thead class="bg-gray-100 text-gray-700 uppercase">
        <tr>
          <th class="px-4 py-2">Exam Type</th>
          <th class="px-4 py-2">Paper Type</th>
          <th class="px-4 py-2">Sub Paper Type</th>
          <th class="px-4 py-2">Year</th>
          <th class="px-4 py-2">PDF Link</th>
          <th class="px-4 py-2 text-center">Actions</th>
        </tr>
      </thead>
      <tbody id="pyq-table-body">
        <!-- New PYQ Row moved to top -->
        <tr id="new-pyq-row" class="hidden">
          <form method="POST" action="{{ url_for('admin.add_pyq') }}">
            <td class="px-4 py-2">
              <input
                name="exam_type"
                required
                class="border rounded px-2 py-1 w-full"
              />
            </td>
            <td class="px-4 py-2">
              <input
                name="paper_type"
                required
                class="border rounded px-2 py-1 w-full"
              />
            </td>
            <td class="px-4 py-2">
              <input
                name="sub_paper_type"
                class="border rounded px-2 py-1 w-full"
              />
            </td>
            <td class="px-4 py-2">
              <input
                name="year"
                type="number"
                required
                class="border rounded px-2 py-1 w-32"
              />
            </td>
            <td class="px-4 py-2">
              <input
                name="pdf_link"
                type="url"
                required
                class="border rounded px-2 py-1 w-full"
              />
            </td>
            <td class="px-4 py-2 text-center">
              <button
                type="submit"
                class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
              >
                Save
              </button>
            </td>
          </form>
        </tr>

        {% for pyq in pyqs %}
        <tr class="border-b hover:bg-gray-50" id="row-{{ pyq.id }}">
          <td class="px-4 py-2" id="exam_type-{{ pyq.id }}">
            {{ pyq.exam_type }}
          </td>
          <td class="px-4 py-2" id="paper_type-{{ pyq.id }}">
            {{ pyq.paper_type }}
          </td>
          <td class="px-4 py-2" id="sub_paper_type-{{ pyq.id }}">
            {{ pyq.sub_paper_type }}
          </td>
          <td class="px-4 py-2" id="year-{{ pyq.id }}">{{ pyq.year }}</td>
          <td class="px-4 py-2" id="pdf_link-{{ pyq.id }}">
            <span id="link-text-{{ pyq.id }}">{{ pyq.pdf_link }}</span>
            <input
              type="url"
              id="input-pdf_link-{{ pyq.id }}"
              value="{{ pyq.pdf_link }}"
              class="hidden border rounded px-2 py-1 w-full"
            />
          </td>
          <td class="px-4 py-2 text-center">
            <div class="flex justify-center space-x-2">
              <button
                onclick="toggleEdit('{{ pyq.id }}')"
                class="text-blue-600 border border-blue-600 px-2 py-1 rounded hover:bg-blue-50"
                id="edit-btn-{{ pyq.id }}"
              >
                Edit
              </button>
              <button
                onclick="saveEdit('{{ pyq.id }}')"
                class="text-green-600 border border-green-600 px-2 py-1 rounded hover:bg-green-50 hidden"
                id="save-btn-{{ pyq.id }}"
              >
                Save
              </button>
              <form
                method="POST"
                action="{{ url_for('admin.delete_pyq', pyq_id=pyq.id) }}"
                onsubmit="return confirm('Are you sure you want to delete this PYQ?');"
              >
                <button
                  type="submit"
                  class="text-red-600 border border-red-600 px-2 py-1 rounded hover:bg-red-50"
                >
                  Delete
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  function toggleEdit(id) {
    ["exam_type", "paper_type", "sub_paper_type", "year", "pdf_link"].forEach(
      (field) => {
        const cell = document.getElementById(field + "-" + id);
        const val = cell.innerText.trim();

        if (field === "pdf_link") {
          document.getElementById("link-text-" + id).classList.add("hidden");
          document
            .getElementById("input-pdf_link-" + id)
            .classList.remove("hidden");
        } else {
          const widthClass = field === "year" ? "w-32" : "w-full";
          cell.innerHTML = `<input type="text" id="input-${field}-${id}" value="${val}" class="border rounded px-2 py-1 ${widthClass}">`;
        }
      }
    );

    document.getElementById("edit-btn-" + id).classList.add("hidden");
    document.getElementById("save-btn-" + id).classList.remove("hidden");
  }

  function saveEdit(id) {
    const data = {};
    ["exam_type", "paper_type", "sub_paper_type", "year", "pdf_link"].forEach(
      (field) => {
        if (field === "pdf_link") {
          data[field] = document.getElementById("input-pdf_link-" + id).value;
        } else {
          data[field] = document.getElementById(
            "input-" + field + "-" + id
          ).value;
        }
      }
    );

    fetch(`/admin/edit-pyq/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    }).then((res) => {
      if (res.ok) {
        [
          "exam_type",
          "paper_type",
          "sub_paper_type",
          "year",
          "pdf_link",
        ].forEach((field) => {
          if (field === "pdf_link") {
            document.getElementById("link-text-" + id).innerText = data[field];
            document
              .getElementById("link-text-" + id)
              .classList.remove("hidden");
            document
              .getElementById("input-pdf_link-" + id)
              .classList.add("hidden");
          } else {
            document.getElementById(field + "-" + id).innerText = data[field];
          }
        });
        document.getElementById("edit-btn-" + id).classList.remove("hidden");
        document.getElementById("save-btn-" + id).classList.add("hidden");
      } else {
        alert("Failed to update PYQ");
      }
    });
  }

  function addNewRow() {
    document.getElementById("new-pyq-row").classList.remove("hidden");
  }

  document
    .getElementById("search-input")
    .addEventListener("input", function () {
      const query = this.value.toLowerCase();
      const rows = document.querySelectorAll("#pyq-table-body tr");
      rows.forEach((row) => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(query) ? "" : "none";
      });
    });
</script>
{% endblock %}
